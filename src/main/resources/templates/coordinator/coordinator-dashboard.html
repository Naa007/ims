<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!-- Head -->
<head th:replace="fragments/head :: head('Coordinator Dashboard')"></head>
<body>
<!-- Header -->
<header th:replace="fragments/header :: header"></header>

<main class="container">
    <!-- Dashboard Container -->
    <div class="dashboard-container">

        <!-- Dashboard Tabs -->
        <div class="dashboard-tabs">
            <a href="/inspection/inspection-management" class="tab">
                <i class="fas fa-clipboard-check"></i>
                <span>Inspection Management</span>
            </a>
            <a href="#" class="tab" onclick="togglePerformanceContainer(this)">
                <i class="fas fa-chart-bar"></i>
                <span>Stats</span>
            </a>
            <a href="#" class="tab">
                <i class="fas fa-calendar-alt"></i>
                <span>Calendar</span>
            </a>
        </div>

        <!-- Coordinator Performance Stats -->
        <div id="performanceContainer" class="cd-stats-container" style="display: none">
            <h4 class="section-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; justify-content: flex-start;">
                        <i class="fas fa-chart-line me-2"></i>
                        <span th:text="${employeeName + '''s Dashboard'}">My Performance Dashboard</span>
                    </div>
                    <div class="bd-date-filter date">
                        <span th:text="${#temporals.format(#temporals.createNow(), 'MMMM dd, yyyy')}">May 03, 2025</span>
                    </div>
                    <span class="user-email" th:text="${userEmail}" style="display:none;"></span>
                </div>
            </h4>
            <!-- Performance Metrics Display -->
            <div class="cd-performance-metrics-container">
                <div class="cd-metrics-display">
                    <!-- Time Period Selection -->
                    <div class="cd-period-selection">
                        <div class="cd-filter-group">
                            <label for="periodSelect">Time Range:</label>
                            <select class="cd-period-select" id="periodSelect">
                                <option value="" disabled selected>Select a range</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            <div id="customRangeContainer" style="display: none;">
                                <div class="cd-custom-range-content">
                                    <input id="startDate" name="startDate" type="date" style="width: calc(100% - 1.5rem); padding: 0.375rem 0.75rem; border-radius: 0.25rem; border: 1px solid #d1d3e2; font-size: 0.9rem;">
                                    <input id="endDate" name="endDate" type="date" style="width: calc(100% - 1.5rem); padding: 0.375rem 0.75rem; border-radius: 0.25rem; border: 1px solid #d1d3e2; font-size: 0.9rem;">

                                    <button id = "applyCustomRangeBtn" class="cd-filter-btn" style="width: calc(100% - 1.5rem);padding: 0.375rem 0.75rem;border-radius: 0.25rem;/* border: 1px solid #d1d3e2; */font-size: 0.9rem;"  type="button">
                                        <i class="fas fa-check-circle" style="margin-right: 5px;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Export Options -->
                        <div class="cd-export-wrapper">
                            <div class="bd-filter-group bd-export-group">
                                <button class="bd-export-btn" id="exportPdfBtn">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="bd-export-btn" id="exportExcelBtn">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="cd-metrics-total">
                        <span class="cd-total-number" id="totalInspections" th:text="${inspectionStats.totalInspections}">0</span>
                        <span class="cd-total-label">Total Inspections</span>
                    </div>
                    <div class="cd-metrics-breakdown">
                        <div class="cd-metric-item">
                            <span class="cd-metric-value" id="newInspections" th:text="${inspectionStats.newInspections}">0</span>
                            <span class="cd-metric-label">New</span>
                        </div>
                        <div class="cd-metric-item">
                            <span class="cd-metric-value" id="ongoingInspections" th:text="${inspectionStats.ongoingInspections}">0</span>
                            <span class="cd-metric-label">Ongoing</span>
                        </div>
                        <div class="cd-metric-item">
                            <span class="cd-metric-value" id="awardedInspections" th:text="${inspectionStats.completedInspections}">0</span>
                            <span class="cd-metric-label">Awarded</span>
                        </div>
                        <div class="cd-metric-item">
                            <span class="cd-metric-value" id="rejectedInspections" th:text="${inspectionStats.rejectedInspections}">0</span>
                            <span class="cd-metric-label">Rejected</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <h2>You are in COORDINATOR DASHBOARD</h2>
            <p>
                Use the tiles above to manage inspections, reports, and much more. Stay organized and efficient with our
                comprehensive management tools.
            </p>
        </div>

    </div>
</main>

<!-- Footer -->
<footer th:replace="fragments/footer :: footer"></footer>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date inputs
        initializeDateInputs();

        // Set up event listeners
        document.getElementById('periodSelect').addEventListener('change', handlePeriodChange);
        document.getElementById('applyCustomRangeBtn').addEventListener('click', applyCustomRange);
        document.getElementById('exportPdfBtn').addEventListener('click', () => exportCoordinatorData('pdf'));
        document.getElementById('exportExcelBtn').addEventListener('click', () => exportCoordinatorData('excel'));
    });

    // Initialize date inputs with default values
    function initializeDateInputs() {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);

        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
        document.getElementById('endDate').value = formatDate(today);
    }

    // Handle period change
    function handlePeriodChange() {
        const periodSelect = document.getElementById('periodSelect');
        const customRangeContainer = document.getElementById('customRangeContainer');

        if (periodSelect.value === 'custom') {
            customRangeContainer.style.display = 'block';
        } else {
            customRangeContainer.style.display = 'none';
            fetchDataForPeriod(periodSelect.value);
        }
    }

    // Apply custom date range
    function applyCustomRange() {
        const period = document.getElementById('periodSelect').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (startDate && endDate) {
        if (new Date(startDate) > new Date(endDate)) {
        showNotification('Start date cannot be after end date', 'error');
            return;
          }
            fetchDataForCustomRange(period,startDate, endDate);
        } else {
            showNotification('Please select both start and end dates', 'error');
        }
    }

    // Fetch data for a specific period
    function fetchDataForPeriod(period) {
        showLoadingIndicator();

        const coordinatorEmail = document.querySelector('.user-email').textContent;

        fetch(`/stats/coordinator-stats/${encodeURIComponent(coordinatorEmail)}/${period}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                updateMetricsDisplay(data);
                hideLoadingIndicator();
                showNotification('Data updated successfully', 'success');
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                hideLoadingIndicator();
                showNotification('Failed to load performance data', 'error');
            });
    }

    // Update the metrics display with the latest data
    function updateMetricsDisplay(data) {
        // Update the total inspections count
        const totalElement = document.getElementById('totalInspections');
        if (totalElement) {
            totalElement.textContent = data['totalInspections'] || 0;
            totalElement.classList.add('cd-total-highlight');
            setTimeout(() => totalElement.classList.remove('cd-total-highlight'), 1500);
        }

        // Update individual metrics
       const metrics = {
            'newInspections': 'newInspections',
            'ongoingInspections': 'ongoingInspections',
            'awardedInspections': 'completedInspections',
            'rejectedInspections': 'rejectedInspections'
        };

        for (const [elementId, dataKey] of Object.entries(metrics)) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = data[dataKey] || 0;
            }
        }
    }

   // Fetch data for custom date range
function fetchDataForCustomRange(period, startDate, endDate) {
    showLoadingIndicator();

    const coordinatorEmail = document.querySelector('.user-email').textContent;
    let url = `/stats/coordinator-stats/${encodeURIComponent(coordinatorEmail)}/${period}?startDate=${startDate}&endDate=${endDate}`;

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            updateMetricsDisplay(data);
            hideLoadingIndicator();
            showNotification('Custom range data loaded', 'success');
        })
        .catch(error => {
            console.error('Error fetching custom range data:', error);
            hideLoadingIndicator();
            showNotification('Failed to load custom range data', 'error');
        });
}

    // Show loading indicator
    function showLoadingIndicator() {
        // You can implement this if you have a loading indicator element
    }

    // Hide loading indicator
    function hideLoadingIndicator() {
        // You can implement this if you have a loading indicator element
    }

    // Show notification
    function showNotification(message, type = 'info') {
        const notificationContainer = document.getElementById('cd-notification-container') || createNotificationContainer();

        const notification = document.createElement('div');
        notification.className = `cd-notification cd-notification-${type}`;

        let icon;
        switch (type) {
            case 'success': icon = 'fa-check-circle'; break;
            case 'error': icon = 'fa-times-circle'; break;
            case 'warning': icon = 'fa-exclamation-triangle'; break;
            default: icon = 'fa-info-circle';
        }

        notification.innerHTML = `
            <div class="cd-notification-icon">
                <i class="fas ${icon}"></i>
            </div>
            <div class="cd-notification-content">
                ${message}
            </div>
            <div class="cd-notification-close">
                <i class="fas fa-times"></i>
            </div>
        `;

        notificationContainer.appendChild(notification);

        // Add close event
        notification.querySelector('.cd-notification-close').addEventListener('click', function() {
            notification.classList.add('cd-notification-hiding');
            setTimeout(() => notification.remove(), 300);
        });

        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.classList.add('cd-notification-hiding');
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }

    // Create notification container if it doesn't exist
    function createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'cd-notification-container';
        document.body.appendChild(container);
        return container;
    }

    function exportCoordinatorData(format) {
        const exportBtn = event.target;
        exportBtn.disabled = true;

        const dashboardHeader = document.querySelector('.section-header span');
        const coordinatorName = dashboardHeader ?
            dashboardHeader.textContent.replace('My Performance Dashboard - ', '') :
            'coordinator_report';

        let period = document.getElementById('periodSelect').value;
         // If no period is selected, use current month as default (yyyy-MM)
       if (!period) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        period = `${year}-${month}`;
       }
        const employeeName = /*[[${employeeName}]]*/ coordinatorName;
        const encodedName = encodeURIComponent(employeeName.replace(/\s+/g, '_'));

        const endpoint = `/stats/coordinator-report/${encodedName}/${period}/${format}`;
        const filename = `${encodedName}_report.${format === 'pdf' ? 'pdf' : 'xlsx'}`;

        fetch(endpoint)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error: ${response.status}`);
                }
                return response.blob();
            })
            .then(blob => {
              if (blob.size === 0) {
                showNotification('No data available for report generation', 'warning');
                return;
            }
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(link.href);

                showNotification(`${format.toUpperCase()} downloaded successfully.`, 'success');
            })
            .catch(error => {
                console.error('Download failed:', error);
                showNotification(`Failed to export ${format.toUpperCase()} report.`, 'error');
            })
            .finally(() => {
                exportBtn.disabled = false;
            });
    }
    function togglePerformanceContainer(element) {
        const performanceContainer = document.getElementById('performanceContainer');
        if (performanceContainer.style.display === 'none') {
            performanceContainer.style.display = 'block';
            document.querySelectorAll('.dashboard-tabs .tab').forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
        } else {
            performanceContainer.style.display = 'none';
            element.classList.remove('active');
        }
    }
</script>

<style>
    /* Coordinator Dashboard Specific Styles */
    .cd-stats-container {
        width: 100%;
    }

    .cd-performance-metrics-container {
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .cd-metrics-display {
        display: flex;
        flex-direction: column;
    }

    .cd-metrics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .cd-metrics-header h3 {
        margin: 0;
        color: #5a5c69;
        font-weight: 700;
    }

    .cd-metrics-total {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .cd-total-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #36b9cc;
    }

    .cd-total-label {
        color: #858796;
        font-size: 0.9rem;
    }

    .cd-metrics-breakdown {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .cd-metric-item {
        flex: 1;
        min-width: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        background-color: #f8f9fc;
        border-radius: 0.5rem;
    }

    .cd-metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #5a5c69;
    }

    .cd-metric-label {
        color: #858796;
        font-size: 0.9rem;
    }

    .cd-total-highlight {
        animation: highlight-pulse 1.5s ease-in-out;
    }

    @keyframes highlight-pulse {
        0% { color: #1cc88a; }
        50% { color: #17a673; }
        100% { color: #1cc88a; }
    }

    .cd-period-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: center;
    }

    .cd-filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .cd-period-select {
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #d1d3e2;
        font-size: 0.9rem;
    }

    .cd-custom-range-content {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .cd-date-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .cd-date-input-group input {
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #d1d3e2;
        font-size: 0.9rem;
    }

    .cd-filter-btn {
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        background-color: #4e73df;
        color: white;
        border: none;
        cursor: pointer;
        align-self: flex-end;
    }

    .cd-filter-btn:hover {
        background-color: #2e59d9;
    }

    /* Notification Component */
    #cd-notification-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1050;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .cd-notification {
        display: flex;
        align-items: center;
        min-width: 300px;
        max-width: 450px;
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        padding: 1rem;
        opacity: 1;
        transform: translateX(0);
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    .cd-notification-hiding {
        opacity: 0;
        transform: translateX(100%);
    }

    .cd-notification-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 1rem;
        font-size: 1rem;
    }

    .cd-notification-success .cd-notification-icon {
        color: #1cc88a;
    }

    .cd-notification-error .cd-notification-icon {
        color: #e74a3b;
    }

    .cd-notification-warning .cd-notification-icon {
        color: #f6c23e;
    }

    .cd-notification-info .cd-notification-icon {
        color: #4e73df;
    }

    .cd-notification-content {
        flex: 1;
        font-size: 0.9rem;
        color: #5a5c69;
    }

    .cd-notification-close {
        color: #858796;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 0.25rem;
    }

    .cd-notification-close:hover {
        color: #5a5c69;
    }

    .bd-export-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        background-color: #f8f9fc;
        color: #5a5c69;
        border: 1px solid #e3e6f0;
        transition: all 0.2s ease;
    }

    .bd-export-btn:hover {
        background-color: #eaecf4;
    }

    .bd-export-btn i {
        margin-right: 5px;
    }

    /* Add these new styles */
    .cd-period-selection {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .cd-export-wrapper {
        margin-left: auto;
    }

    .bd-export-group {
        display: flex;
        gap: 0.5rem;
    }

    /* Update existing styles for better alignment */
    .cd-filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    @media (max-width: 768px) {
        .cd-period-selection {
            flex-direction: column;
            align-items: flex-start;
        }

        .cd-export-wrapper {
            margin-left: 0;
            width: 100%;
        }

        .bd-export-group {
            justify-content: flex-end;
        }

        .cd-metrics-breakdown {
            flex-direction: column;
        }

        .cd-metric-item {
            min-width: 100%;
        }
    }
</style>
</body>
</html>