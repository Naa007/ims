<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!-- Head -->
<head th:replace="fragments/head :: head('Coordinator Dashboard')"></head>
<body>
<header th:replace="fragments/header :: header"></header>

<main class="container">
    <div class="dashboard-container">
        <div class="dashboard-tabs">
            <a href="/technical-coordinator/inspection-management" class="tab">
                <i class="fas fa-clipboard-check"></i>
                <span>Inspections Management</span>
            </a>
        </div>

        <div class="cd-stats-container">
            <h4 class="section-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; justify-content: flex-start;">
                        <i class="fas fa-chart-line me-2"></i>
                        <span th:text="'My Performance Dashboard - ' + ${employeeName}">My Performance Dashboard</span>
                    </div>
                    <input type="hidden" id="employeeId" th:value="${employeeId}" />
                    <div class="bd-date-filter date">
                        <span th:text="${#temporals.format(#temporals.createNow(), 'MMMM dd, yyyy')}">May 03, 2025</span>
                    </div>
                    <span class="user-email" th:text="${email}" style="display:none;"></span>
                </div>
            </h4>

            <div class="cd-performance-metrics-container">
                <div class="cd-metrics-display">
                    <div class="cd-metrics-header">
                        <h3>My Performance</h3>
                    </div>

                    <div class="cd-period-selection">
                        <div class="cd-filter-group">
                            <label for="periodSelect">Time Range:</label>
                            <select class="cd-period-select" id="periodSelect" onchange="handlePeriodChange()">
                                <option value="" disabled selected>Select a range</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                                <option value="year">Year to Date</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>

                        <div class="cd-export-wrapper">
                            <div class="bd-filter-group bd-export-group">
                                <button class="bd-export-btn" onclick="exportTechCoordinatorData('pdf')">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="bd-export-btn" onclick="exportTechCoordinatorData('excel')">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>

                        <div id="customRangeContainer" style="display: none;">
                            <div class="cd-custom-range-content">
                                <div class="cd-date-input-group">
                                    <label for="startDate">From:</label>
                                    <input id="startDate" name="startDate" type="date">
                                </div>
                                <div class="cd-date-input-group">
                                    <label for="endDate">To:</label>
                                    <input id="endDate" name="endDate" type="date">
                                </div>
                                <button class="cd-filter-btn" onclick="applyCustomRange()" type="button">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="cd-metrics-total">
                        <span class="cd-total-number" id="totalInspections" th:text="${technicalCoordinatorStats['Total Inspections']}">0</span>
                        <span class="cd-total-label">Total Inspections</span>
                    </div>

                    <div class="cd-metrics-breakdown">
                        <div class="cd-metric-item">
                            <span class="cd-metric-value" id="newInspections" th:text="${technicalCoordinatorStats['New']}">0</span>
                            <span class="cd-metric-label">New</span>
                        </div>
                        <div class="cd-metric-item">
                            <span class="cd-metric-value" id="ongoingInspections" th:text="${technicalCoordinatorStats['Ongoing']}">0</span>
                            <span class="cd-metric-label">Ongoing</span>
                        </div>
                        <div class="cd-metric-item">
                            <span class="cd-metric-value" id="awardedInspections" th:text="${technicalCoordinatorStats['Awarded']}">0</span>
                            <span class="cd-metric-label">Awarded</span>
                        </div>
                        <div class="cd-metric-item">
                            <span class="cd-metric-value" id="rejectedInspections" th:text="${technicalCoordinatorStats['Rejected']}">0</span>
                            <span class="cd-metric-label">Rejected</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="fragments/footer :: footer"></footer>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        initializeDateInputs();
    });

    function initializeDateInputs() {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);

        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
        document.getElementById('endDate').value = formatDate(today);
    }

    function handlePeriodChange() {
        const periodSelect = document.getElementById('periodSelect');
        const customRangeContainer = document.getElementById('customRangeContainer');

        if (periodSelect.value === 'custom') {
            customRangeContainer.style.display = 'block';
        } else {
            customRangeContainer.style.display = 'none';
            fetchDataForPeriod(periodSelect.value);
        }
    }

    function applyCustomRange() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (startDate && endDate) {
            fetchDataForCustomRange(startDate, endDate);
        } else {
            showNotification('Please select both start and end dates', 'error');
        }
    }

    function fetchDataForPeriod(period) {
        const employeeID = document.getElementById('employeeId').value;
        if (!employeeID) {
            showNotification('Employee ID not found', 'error');
            return;
        }

        fetch(`/stats/technical-coordinator-stats/${encodeURIComponent(employeeID)}/${period}`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                updateMetricsDisplay(data);
                showNotification('Data updated successfully', 'success');
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                showNotification('Failed to load performance data', 'error');
            });
    }

    function updateMetricsDisplay(data) {
        const totalElement = document.getElementById('totalInspections');
        if (totalElement) {
            totalElement.textContent = data['totalInspections'] || 0;
            totalElement.classList.add('cd-total-highlight');
            setTimeout(() => totalElement.classList.remove('cd-total-highlight'), 1500);
        }

        const metrics = {
            'newInspections': 'newInspections',
            'ongoingInspections': 'ongoingInspections',
            'awardedInspections': 'completedInspections',
            'rejectedInspections': 'rejectedInspections'
        };

        for (const [elementId, dataKey] of Object.entries(metrics)) {
            const element = document.getElementById(elementId);
            if (element) element.textContent = data[dataKey] || 0;
        }
    }

    function fetchDataForCustomRange(startDate, endDate) {
        const employeeID = document.getElementById('employeeId').value;
        if (!employeeID) {
            showNotification('Employee ID not found', 'error');
            return;
        }

        fetch(`/technical-coordinator/inspection-stats/${encodeURIComponent(employeeID)}/custom?startDate=${startDate}&endDate=${endDate}`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                updateMetricsDisplay(data);
                showNotification('Custom range data loaded', 'success');
            })
            .catch(error => {
                console.error('Error fetching custom range data:', error);
                showNotification('Failed to load custom range data', 'error');
            });
    }

    function exportTechCoordinatorData(format) {
    const exportBtn = event.target;
    exportBtn.Disabled = true;
        const employeeID = document.getElementById('employeeId').value;
        if (!employeeID) {
            showNotification('Employee ID not found', 'error');
            return;
        }

        const dashboardHeader = document.querySelector('.section-header span');
        const coordinatorName = dashboardHeader ?
            dashboardHeader.textContent.replace('My Performance Dashboard - ', '') :
            'technical_coordinator_report';

        let period = document.getElementById('periodSelect').value;
               // If no period is selected, use current month as default (yyyy-MM)
       if (!period) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        period = `${year}-${month}`;
       }
        const filename = `${coordinatorName.replace(/\s+/g, '_')}_report.${format === 'pdf' ? 'pdf' : 'xlsx'}`;

        fetch(`/stats/technical-coordinator-report/${employeeID}/${period}/${format}`)
            .then(response => {
                if (!response.ok) throw new Error(`Error: ${response.status}`);
                return response.blob();
            })
            .then(blob => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }, 100);
                showNotification(`${format.toUpperCase()} downloaded successfully`, 'success');
            })
            .catch(error => {
                console.error('Export failed:', error);
                showNotification(`Export failed: ${error.message}`, 'error');
            })  .finally(() => {
            exportBtn.Disabled = false;
        });
    }

    function showNotification(message, type = 'info') {
        const notificationContainer = document.getElementById('cd-notification-container') || createNotificationContainer();
        const icon = {
            'success': 'fa-check-circle',
            'error': 'fa-times-circle',
            'warning': 'fa-exclamation-triangle',
            'info': 'fa-info-circle'
        }[type] || 'fa-info-circle';

        const notification = document.createElement('div');
        notification.className = `cd-notification cd-notification-${type}`;
        notification.innerHTML = `
            <div class="cd-notification-icon">
                <i class="fas ${icon}"></i>
            </div>
            <div class="cd-notification-content">${message}</div>
            <div class="cd-notification-close"><i class="fas fa-times"></i></div>
        `;

        notificationContainer.appendChild(notification);
        notification.querySelector('.cd-notification-close').addEventListener('click', () => removeNotification(notification));
        setTimeout(() => removeNotification(notification), 5000);
    }

    function removeNotification(notification) {
        notification.classList.add('cd-notification-hiding');
        setTimeout(() => notification.remove(), 300);
    }

    function createNotificationContainer() {
        const container = document.createElement('div');
        container.id = 'cd-notification-container';
        document.body.appendChild(container);
        return container;
    }
</script>

<style>
    .cd-stats-container {
        width: 100%;
        padding: 1rem;
    }

    .cd-performance-metrics-container {
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .cd-metrics-display {
        display: flex;
        flex-direction: column;
    }

    .cd-metrics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .cd-metrics-header h3 {
        margin: 0;
        color: #5a5c69;
        font-weight: 700;
    }

    .cd-metrics-total {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .cd-total-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #36b9cc;
    }

    .cd-total-label {
        color: #858796;
        font-size: 0.9rem;
    }

    .cd-metrics-breakdown {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .cd-metric-item {
        flex: 1;
        min-width: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        background-color: #f8f9fc;
        border-radius: 0.5rem;
    }

    .cd-metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #5a5c69;
    }

    .cd-metric-label {
        color: #858796;
        font-size: 0.9rem;
    }

    .cd-total-highlight {
        animation: highlight-pulse 1.5s ease-in-out;
    }

    @keyframes highlight-pulse {
        0% { color: #1cc88a; }
        50% { color: #17a673; }
        100% { color: #1cc88a; }
    }

    .cd-period-selection {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .cd-filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .cd-period-select {
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #d1d3e2;
        font-size: 0.9rem;
    }

    .cd-custom-range-content {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 0.5rem;
    }

    .cd-date-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .cd-date-input-group input {
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #d1d3e2;
        font-size: 0.9rem;
    }

    .cd-filter-btn {
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        background-color: #36b9cc;
        color: white;
        border: none;
        cursor: pointer;
        align-self: flex-end;
    }

    .cd-filter-btn:hover {
        background-color: #2c9faf;
    }

    .cd-export-wrapper {
        margin-left: auto;
    }

    .bd-export-group {
        display: flex;
        gap: 0.5rem;
    }

    .bd-export-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        background-color: #f8f9fc;
        color: #5a5c69;
        border: 1px solid #e3e6f0;
        transition: all 0.2s ease;
    }

    .bd-export-btn:hover {
        background-color: #eaecf4;
    }

    .bd-export-btn i {
        margin-right: 5px;
    }

    #cd-notification-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1050;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .cd-notification {
        display: flex;
        align-items: center;
        min-width: 300px;
        max-width: 450px;
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        padding: 1rem;
        opacity: 1;
        transform: translateX(0);
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    .cd-notification-hiding {
        opacity: 0;
        transform: translateX(100%);
    }

    .cd-notification-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 1rem;
        font-size: 1rem;
    }

    .cd-notification-success .cd-notification-icon {
        color: #1cc88a;
    }

    .cd-notification-error .cd-notification-icon {
        color: #e74a3b;
    }

    .cd-notification-warning .cd-notification-icon {
        color: #f6c23e;
    }

    .cd-notification-info .cd-notification-icon {
        color: #36b9cc;
    }

    .cd-notification-content {
        flex: 1;
        font-size: 0.9rem;
        color: #5a5c69;
    }

    .cd-notification-close {
        color: #858796;
        cursor: pointer;
        font-size: 0.8rem;
        padding: 0.25rem;
    }

    .cd-notification-close:hover {
        color: #5a5c69;
    }

    @media (max-width: 768px) {
        .cd-period-selection {
            flex-direction: column;
            align-items: flex-start;
        }

        .cd-export-wrapper {
            margin-left: 0;
            width: 100%;
        }

        .bd-export-group {
            justify-content: flex-end;
        }

        .cd-metrics-breakdown {
            flex-direction: column;
        }

        .cd-metric-item {
            min-width: 100%;
        }

        .cd-custom-range-content {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
</body>
</html>